<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <!-- Remove aframe-extras since we're using custom movement -->
    <script src="https://unpkg.com/aframe-environment-component@1.3.x/dist/aframe-environment-component.min.js"></script>
</head>
<body>
    <a-scene>
        <a-assets>
            <img id="wood-texture" src="images/box-wood-mesh.png">
            <img id="steel-texture" src="images/steel-mesh.png">
            <img id="fire-texture" src="images/fire-mesh.jpg">
            <img id="grass-texture" src="images/grass-texture.jpg">
        </a-assets>

        <a-box id="box" src="#wood-texture" position="-2.30768 0.52215 -3" rotation="0 45 0"></a-box>
        <a-sphere id="sphere" src="#fire-texture" position="0.03093 1.25 -5" radius="1.25" 
            animation="property: object3D.rotation.y; to: 122.2; dir: alternate; dur: 2000; loop: true"></a-sphere>
        <a-cylinder id="cylinder" src="#steel-texture" position="2.48107 0.75 -3" radius="0.5" height="1.5"></a-cylinder>
        <a-plane id="plane" src="#grass-texture" rotation="-90 0 0" width="30" height="30" repeat="10 10"></a-plane>
        <a-sky id="sky" color="#87CEEB"></a-sky>
        <a-entity text="value: Hello, welcome!; color: #FAFAFA; width: 5; anchor: align"
            position="-0.9 0.2 -3" scale="1.5 1.5 1.5">
        </a-entity>

        <a-light type="ambient" color="#445451"></a-light>
        <a-light type="point" intensity="7" position="2 4 4"></a-light>

        <!-- Corrected Camera Setup -->
        <a-entity id="camera-rig" position="0 1.6 2">
            <a-entity id="camera" 
                      camera
                      look-controls
                      thumbstick-movement>
            </a-entity>
            <a-entity laser-controls="hand: right"></a-entity>
            <a-entity laser-controls="hand: left"></a-entity>
        </a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('thumbstick-movement', {
            init: function () {
                this.velocity = new THREE.Vector3();
                this.speed = 0.1;
                this.rig = document.querySelector('#camera-rig');
                
                this.el.addEventListener('thumbstickmoved', (evt) => {
                    const { x, y } = evt.detail;
                    
                    // Get camera direction
                    const direction = new THREE.Vector3();
                    this.el.object3D.getWorldDirection(direction);
                    direction.y = 0;
                    direction.normalize();
                    
                    // Calculate movement vector
                    const forward = new THREE.Vector3(0, 0, -1);
                    forward.applyQuaternion(this.el.object3D.quaternion);
                    forward.y = 0;
                    forward.normalize();
                    
                    const right = new THREE.Vector3(1, 0, 0);
                    right.applyQuaternion(this.el.object3D.quaternion);
                    right.y = 0;
                    right.normalize();
                    
                    // Combine movement
                    this.velocity.x = forward.x * y + right.x * x;
                    this.velocity.z = forward.z * y + right.z * x;
                    this.velocity.multiplyScalar(this.speed);
                });
                
                this.el.addEventListener('thumbstickend', () => {
                    this.velocity.set(0, 0, 0);
                });
            },
            
            tick: function () {
                // Apply movement to the rig, not the camera
                const rig = document.querySelector('#camera-rig');
                const newPosition = rig.object3D.position.clone();
                newPosition.add(this.velocity);
                rig.object3D.position.copy(newPosition);
            }
        });
    </script>
</body>
</html>