<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR</title>
    <!--Import A-Frame-->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <!--A-Frame Extras-->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <!--Community Physics System-->
    <script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>
    <!--Environment Components-->
    <script src="https://unpkg.com/aframe-environment-component@1.3.x/dist/aframe-environment-component.min.js"></script>
</head>
<body>
    <!--Main A-Frame Scene-->
    <a-scene physics="debug: false; gravity: -9.8" xr-mode-ui="XRMode: vr">
        <!--Assets-->
        <a-assets>
            <img id="wood-texture" src="images/box-wood-mesh.png">
            <img id="steel-texture" src="images/steel-mesh.png">
            <img id="fire-texture" src="images/fire-mesh.jpg">
            <img id="grass-texture" src="images/grass-texture.jpg">
        </a-assets>

        <!-- Camera Rig with movement controls -->
        <a-entity id="cameraRig">
            <!-- Camera -->
            <a-entity id="camera" camera position="0 1.6 0" look-controls></a-entity>
            
            <!-- Left Controller -->
            <a-entity id="leftController" 
                      meta-touch-controls="hand: left"
                      raycaster="objects: [dynamic-body], [static-body]">
                <a-entity geometry="primitive: ring" radius-inner="0.01" radius-outer="0.02" 
                          material="color: white" position="0 0 -0.1" rotation="-90 0 0"></a-entity>
            </a-entity>
            
            <!-- Right Controller -->
            <a-entity id="rightController" 
                      meta-touch-controls="hand: right"
                      raycaster="objects: [dynamic-body], [static-body]">
                <a-entity geometry="primitive: ring" radius-inner="0.01" radius-outer="0.02" 
                          material="color: white" position="0 0 -0.1" rotation="-90 0 0"></a-entity>
            </a-entity>
        </a-entity>

        <!--ENTITIES-->
        <!--Box-->
        <a-entity id="box1" 
                  geometry="primitive: box"
                  material="src: #wood-texture"
                  position="-1.10502 0.6 -4.97359" 
                  dynamic-body></a-entity>
                  
        <!--Cylinder-->
        <a-entity id="cylinder1" 
                  geometry="primitive: cylinder; radius: 0.5; height: 1.5"
                  material="src: #steel-texture" 
                  position="1.46853 0.88 -5.1499"
                  dynamic-body></a-entity>

        <!--Plane-->
        <a-entity id="grass-plane" 
                  geometry="primitive: plane; width: 30; height: 30"
                  material="src: #grass-texture; repeat: 10 10"
                  position="0 0 0"
                  rotation="-90 0 0"
                  static-body></a-entity>

        <!--Text-->
        <a-entity id="text"
                  text="value: A-Frame Testing; color: #FAFAFA; width: 5; anchor: align" 
                  position="-0.9 0.2 -3" 
                  scale="1.5 1.5 1.5"></a-entity>

        <!--Ocean-->
        <a-ocean id="ocean"
                 color="aqua" 
                 depth="500" 
                 width="500" 
                 position="0 -0.5 0" 
                 density="250"></a-ocean>

        <!--Lighting-->
        <a-entity id="light-ambient" 
                  light="type: ambient; color: #445451"></a-entity>
        <a-entity id="light-point" 
                  light="type: point; intensity: 30" 
                  position="8 11.6 8"></a-entity>

        <!--Sky-->
        <a-sky id="sky" color="#87CEEB"></a-sky>

    </a-scene>

    <script>
        // Ocean primitive
        AFRAME.registerPrimitive('a-ocean', {
            defaultComponents: {
                ocean: {},
                rotation: {x: -90, y: 0, z: 0},
            },
            mappings: {
                width: 'ocean.width',
                depth: 'ocean.depth',
                density: 'ocean.density',
                color: 'ocean.color',
                opacity: 'ocean.opacity'
            }
        });

        // Improved movement component
        AFRAME.registerComponent('joystick-movement', {
            schema: {
                speed: {type: 'number', default: 0.05},
                enabled: {type: 'boolean', default: true}
            },
            
            init: function() {
                this.velocity = new THREE.Vector3();
                this.direction = new THREE.Vector3();
                this.moveForward = false;
                this.moveBackward = false;
                this.moveLeft = false;
                this.moveRight = false;
                
                // Controller events
                this.onAxisMove = this.onAxisMove.bind(this);
                this.el.sceneEl.addEventListener('axismove', this.onAxisMove);
                
                console.log('Joystick movement component initialized');
            },
            
            onAxisMove: function(evt) {
                if (!this.data.enabled) return;
                if (evt.detail.controller.id.endsWith('leftController')) {
                    const axis = evt.detail.axis;
                    // Left joystick (axis 0 and 1)
                    this.moveForward = axis[1] > 0.3;
                    this.moveBackward = axis[1] < -0.3;
                    this.moveLeft = axis[0] < -0.3;
                    this.moveRight = axis[0] > 0.3;
                    
                    // Debug output
                    if (this.moveForward || this.moveBackward || this.moveLeft || this.moveRight) {
                        console.log('Joystick moved:', {
                            forward: this.moveForward,
                            backward: this.moveBackward,
                            left: this.moveLeft,
                            right: this.moveRight
                        });
                    }
                }
            },
            
            tick: function(time, timeDelta) {
                if (!this.data.enabled) return;
                
                const delta = timeDelta / 1000 * this.data.speed;
                const camera = document.getElementById('camera').object3D;
                const rig = this.el.object3D;
                
                // Dampen velocity
                this.velocity.x *= 0.9;
                this.velocity.z *= 0.9;
                
                // Set direction based on input
                this.direction.z = Number(this.moveForward) - Number(this.moveBackward);
                this.direction.x = Number(this.moveRight) - Number(this.moveLeft);
                
                if (this.direction.length() > 0) {
                    this.direction.normalize();
                    
                    // Get camera forward vector (horizontal only)
                    const forward = new THREE.Vector3();
                    camera.getWorldDirection(forward);
                    forward.y = 0;
                    forward.normalize();
                    
                    // Get camera right vector
                    const right = new THREE.Vector3();
                    right.crossVectors(new THREE.Vector3(0, 1, 0), forward);
                    
                    // Apply movement
                    if (this.moveForward || this.moveBackward) {
                        this.velocity.add(forward.multiplyScalar(-this.direction.z * delta * 5));
                    }
                    if (this.moveLeft || this.moveRight) {
                        this.velocity.add(right.multiplyScalar(this.direction.x * delta * 5));
                    }
                }
                
                // Update position
                rig.position.add(this.velocity.clone().multiplyScalar(delta));
            },
            
            remove: function() {
                this.el.sceneEl.removeEventListener('axismove', this.onAxisMove);
            }
        });

        // Initialize movement when scene loads
        document.querySelector('a-scene').addEventListener('loaded', function() {
            const cameraRig = document.getElementById('cameraRig');
            cameraRig.setAttribute('joystick-movement', 'speed: 0.05');
            console.log('Movement system initialized');
            
            // Debug: Check if controllers are present
            const leftController = document.getElementById('leftController');
            const rightController = document.getElementById('rightController');
            console.log('Controllers detected:', {
                left: !!leftController.components['meta-touch-controls'],
                right: !!rightController.components['meta-touch-controls']
            });
        });
    </script>
</body>
</html>